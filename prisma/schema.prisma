// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User & Authentication
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  password      String?

  // Team Leader Persona (optional)
  leaderPersona Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts  Account[]
  sessions  Session[]
  teams     TeamMember[]
  ownedTeams Team[]      @relation("TeamOwner")
  tasks     Task[]      @relation("TaskCreator")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// Team Management
// ============================================================================

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  purpose     String?
  type        String   @default("general") // general, marketing, development, etc.

  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members  TeamMember[]
  agents   Agent[]
  tasks    Task[]
  results  Result[]

  @@map("teams")
}

model TeamMember {
  id     String @id @default(cuid())
  userId String
  teamId String
  role   String @default("member") // owner, admin, member

  joinedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_members")
}

// ============================================================================
// Agent & Persona
// ============================================================================

model Agent {
  id     String      @id @default(cuid())
  teamId String
  name   String
  role   String
  status AgentStatus @default(ACTIVE)

  // Character Image
  imageUrl     String?
  imageType    String? // ai_generated, preset, uploaded

  // Skills & Capabilities
  skills String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  persona  Persona?
  taskAssignments TaskAssignment[]
  workflowSteps   WorkflowStep[]

  @@map("agents")
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  BUSY
}

model Persona {
  id      String @id @default(cuid())
  agentId String @unique

  // Core Persona Attributes
  name               String
  role               String
  personality        String   @db.Text
  expertise          String[]
  communicationStyle String   @db.Text
  background         String?  @db.Text

  // Source Information
  sourceType String? // resume, template, chat
  sourceData Json?   // Original resume data or chat history

  // System Prompt (generated from persona)
  systemPrompt String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("personas")
}

model AgentTemplate {
  id          String   @id @default(cuid())
  name        String
  role        String
  description String?

  // Default Persona Settings
  defaultPersona Json
  defaultSkills  String[]

  // Preset Image
  presetImageUrl String?

  // Categorization
  category String // general, marketing, development, design, etc.

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("agent_templates")
}

// ============================================================================
// Task & Workflow
// ============================================================================

model Task {
  id          String     @id @default(cuid())
  teamId      String
  creatorId   String

  title       String
  description String?    @db.Text
  instruction String?    @db.Text

  // Priority & Deadline
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?

  // Workflow Configuration
  workflowType    WorkflowType    @default(SINGLE)
  supervisionLevel SupervisionLevel @default(MODERATE)

  // Status & Progress
  status   TaskStatus @default(PENDING)
  progress Int        @default(0) // 0-100

  // Results
  finalResult String? @db.Text

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  team        Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator     User             @relation("TaskCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  assignments TaskAssignment[]
  workflow    WorkflowStep[]
  results     Result[]
  history     History[]

  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  AWAITING_REVIEW
  COMPLETED
  FAILED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkflowType {
  SINGLE
  SEQUENTIAL
  PARALLEL
  COLLABORATIVE
}

enum SupervisionLevel {
  FULL
  MODERATE
  MINIMAL
  NONE
}

model TaskAssignment {
  id      String @id @default(cuid())
  taskId  String
  agentId String

  role         String  @default("support") // primary, support
  order        Int     @default(0)
  instruction  String? @db.Text

  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([taskId, agentId])
  @@map("task_assignments")
}

model WorkflowStep {
  id      String @id @default(cuid())
  taskId  String
  agentId String

  // Execution Order
  order         Int  @default(0)
  parallelGroup Int? // Steps in same group run in parallel

  // Step Details
  instruction String? @db.Text

  // Status
  status TaskStatus @default(PENDING)

  // Result
  result    String?   @db.Text
  error     String?   @db.Text
  startedAt DateTime?
  completedAt DateTime?

  // Relations
  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("workflow_steps")
}

// ============================================================================
// Results & History
// ============================================================================

model Result {
  id     String @id @default(cuid())
  taskId String
  teamId String

  // Content
  title       String
  content     String   @db.Text
  contentType String   @default("text") // text, markdown, code, image, file

  // File Info (if applicable)
  fileUrl  String?
  fileName String?
  fileSize Int?
  mimeType String?

  // Approval Status
  status   ResultStatus @default(PENDING)
  feedback String?      @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("results")
}

enum ResultStatus {
  PENDING
  APPROVED
  REJECTED
  REVISION_REQUESTED
}

model History {
  id     String @id @default(cuid())
  taskId String

  // Action Details
  action      String // created, started, step_completed, completed, failed, etc.
  description String @db.Text

  // Additional Data
  metadata Json?

  createdAt DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("history")
}
